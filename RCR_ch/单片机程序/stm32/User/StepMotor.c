#include <stdio.h>
#include "StepMotor.h"
#include "Order.h"

// 延时数组，分快速和慢速两种类型
unsigned int delayTime_180_fast[TURN_180] = {
327064,  85863,  60583,  48474,  41123,  36101,  32413,  29571,  27301,  25439, 
 23878,  22549,  21400,  20396,  19509,  18720,  18011,  17371,  16790,  16260, 
 15773,  15325,  14910,  14526,  14168,  13834,  13521,  13228,  12953,  12693, 
 12448,  12216,  11996,  11788,  11590,  11401,  11222,  11050,  10887,  10730, 
 10580,  10437,  10299,  10167,  10039,   9917,   9799,   9686,   9577,   9471, 
  9369,   9271,   9176,   9084,   8995,   8909,   8826,   8745,   8667,   8591, 
  8517,   8445,   8376,   8309,   8243,   8179,   8117,   8057,   7998,   7941, 
  7885,   7830,   7778,   7726,   7676,   7627,   7579,   7532,   7487,   7442, 
  7398,   7356,   7315,   7274,   7235,   7196,   7158,   7121,   7085,   7050, 
  7015,   6982,   6949,   6916,   6885,   6853,   6823,   6793,   6765,   6736, 
  6708,   6681,   6654,   6628,   6602,   6577,   6553,   6528,   6505,   6482, 
  6459,   6437,   6415,   6394,   6373,   6353,   6332,   6313,   6294,   6275, 
  6256,   6238,   6220,   6203,   6186,   6169,   6153,   6137,   6121,   6106, 
  6091,   6076,   6061,   6047,   6033,   6020,   6007,   5994,   5981,   5969, 
  5956,   5944,   5933,   5921,   5910,   5900,   5889,   5879,   5868,   5859, 
  5849,   5840,   5830,   5821,   5813,   5804,   5796,   5788,   5780,   5772, 
  5765,   5758,   5751,   5744,   5737,   5731,   5725,   5719,   5713,   5707, 
  5702,   5697,   5692,   5687,   5682,   5678,   5673,   5669,   5665,   5662, 
  5658,   5655,   5652,   5649,   5646,   5643,   5641,   5639,   5637,   5635, 
  5633,   5631,   5630,   5629,   5628,   5627,   5626,   5626,   5625,   5625, 

  5625,   5625,   5626,   5626,   5627,   5628,   5629,   5630,   5631,   5633, 
  5635,   5637,   5639,   5641,   5643,   5646,   5649,   5652,   5655,   5658, 
  5662,   5665,   5669,   5673,   5678,   5682,   5687,   5692,   5697,   5702, 
  5707,   5713,   5719,   5725,   5731,   5737,   5744,   5751,   5758,   5765, 
  5772,   5780,   5788,   5796,   5804,   5813,   5821,   5830,   5840,   5849, 
  5859,   5868,   5879,   5889,   5900,   5910,   5921,   5933,   5944,   5956, 
  5969,   5981,   5994,   6007,   6020,   6033,   6047,   6061,   6076,   6091, 
  6106,   6121,   6137,   6153,   6169,   6186,   6203,   6220,   6238,   6256, 
  6275,   6294,   6313,   6332,   6353,   6373,   6394,   6415,   6437,   6459, 
  6482,   6505,   6528,   6553,   6577,   6602,   6628,   6654,   6681,   6708, 
  6736,   6765,   6793,   6823,   6853,   6885,   6916,   6949,   6982,   7015, 
  7050,   7085,   7121,   7158,   7196,   7235,   7274,   7315,   7356,   7398, 
  7442,   7487,   7532,   7579,   7627,   7676,   7726,   7778,   7830,   7885, 
  7941,   7998,   8057,   8117,   8179,   8243,   8309,   8376,   8445,   8517, 
  8591,   8667,   8745,   8826,   8909,   8995,   9084,   9176,   9271,   9369, 
  9471,   9577,   9686,   9799,   9917,  10039,  10167,  10299,  10437,  10580, 
 10730,  10887,  11050,  11222,  11401,  11590,  11788,  11996,  12216,  12448, 
 12693,  12953,  13228,  13521,  13834,  14168,  14526,  14910,  15325,  15773, 
 16260,  16790,  17371,  18011,  18720,  19509,  20396,  21400,  22549,  23878, 
 25439,  27301,  29571,  32413,  36101,  41123,  48474,  60583,  85863, 327064
};
unsigned int delayTime_180_slow[TURN_180] = {
363405,  95403,  67314,  53860,  45692,  40113,  36015,  32857,  30335,  28265, 
 26531,  25055,  23778,  22662,  21677,  20800,  20012,  19301,  18656,  18066, 
 17526,  17027,  16567,  16139,  15742,  15371,  15024,  14698,  14392,  14103, 
 13831,  13573,  13329,  13098,  12878,  12668,  12469,  12278,  12096,  11922, 
 11756,  11596,  11443,  11296,  11155,  11019,  10888,  10762,  10641,  10523, 
 10411,  10301,  10196,  10094,   9995,   9899,   9807,   9717,   9630,   9545, 
  9464,   9384,   9307,   9232,   9159,   9088,   9019,   8952,   8886,   8823, 
  8761,   8700,   8642,   8584,   8529,   8474,   8421,   8369,   8318,   8269, 
  8221,   8174,   8128,   8083,   8039,   7996,   7954,   7913,   7872,   7833, 
  7795,   7757,   7721,   7685,   7650,   7615,   7581,   7548,   7516,   7484, 
  7454,   7423,   7394,   7364,   7336,   7308,   7281,   7254,   7228,   7202, 
  7177,   7152,   7128,   7104,   7081,   7058,   7036,   7014,   6993,   6972, 
  6951,   6931,   6911,   6892,   6873,   6855,   6836,   6819,   6801,   6784, 
  6767,   6751,   6735,   6719,   6704,   6689,   6674,   6660,   6645,   6632, 
  6618,   6605,   6592,   6579,   6567,   6555,   6543,   6532,   6520,   6509, 
  6499,   6488,   6478,   6468,   6458,   6449,   6440,   6431,   6422,   6414, 
  6405,   6397,   6390,   6382,   6375,   6368,   6361,   6354,   6348,   6341, 
  6335,   6330,   6324,   6319,   6314,   6309,   6304,   6299,   6295,   6291, 
  6287,   6283,   6280,   6276,   6273,   6270,   6268,   6265,   6263,   6261, 
  6259,   6257,   6256,   6254,   6253,   6252,   6251,   6251,   6250,   6250, 

  6250,   6250,   6251,   6251,   6252,   6253,   6254,   6256,   6257,   6259, 
  6261,   6263,   6265,   6268,   6270,   6273,   6276,   6280,   6283,   6287, 
  6291,   6295,   6299,   6304,   6309,   6314,   6319,   6324,   6330,   6335, 
  6341,   6348,   6354,   6361,   6368,   6375,   6382,   6390,   6397,   6405, 
  6414,   6422,   6431,   6440,   6449,   6458,   6468,   6478,   6488,   6499, 
  6509,   6520,   6532,   6543,   6555,   6567,   6579,   6592,   6605,   6618, 
  6632,   6645,   6660,   6674,   6689,   6704,   6719,   6735,   6751,   6767, 
  6784,   6801,   6819,   6836,   6855,   6873,   6892,   6911,   6931,   6951, 
  6972,   6993,   7014,   7036,   7058,   7081,   7104,   7128,   7152,   7177, 
  7202,   7228,   7254,   7281,   7308,   7336,   7364,   7394,   7423,   7454, 
  7484,   7516,   7548,   7581,   7615,   7650,   7685,   7721,   7757,   7795, 
  7833,   7872,   7913,   7954,   7996,   8039,   8083,   8128,   8174,   8221, 
  8269,   8318,   8369,   8421,   8474,   8529,   8584,   8642,   8700,   8761, 
  8823,   8886,   8952,   9019,   9088,   9159,   9232,   9307,   9384,   9464, 
  9545,   9630,   9717,   9807,   9899,   9995,  10094,  10196,  10301,  10411, 
 10523,  10641,  10762,  10888,  11019,  11155,  11296,  11443,  11596,  11756, 
 11922,  12096,  12278,  12469,  12668,  12878,  13098,  13329,  13573,  13831, 
 14103,  14392,  14698,  15024,  15371,  15742,  16139,  16567,  17027,  17526, 
 18066,  18656,  19301,  20012,  20800,  21677,  22662,  23778,  25055,  26531, 
 28265,  30335,  32857,  36015,  40113,  45692,  53860,  67314,  95403, 363405
};
unsigned int delayTime_90_fast[TURN_90] = {
183523,  48470,  34322,  27549,  23439,  20635,  18576,  16990,  15725,  14689, 
 13821,  13083,  12445,  11889,  11398,  10962,  10571,  10218,   9899,   9607, 
  9341,   9096,   8870,   8660,   8466,   8285,   8116,   7958,   7809,   7670, 
  7539,   7415,   7299,   7188,   7084,   6985,   6891,   6801,   6716,   6635, 
  6558,   6484,   6414,   6347,   6282,   6221,   6162,   6106,   6052,   6000, 
  5951,   5903,   5858,   5814,   5772,   5732,   5693,   5656,   5620,   5586, 
  5553,   5521,   5491,   5462,   5434,   5407,   5382,   5357,   5334,   5311, 
  5289,   5269,   5249,   5230,   5212,   5195,   5179,   5163,   5148,   5134, 
  5121,   5109,   5097,   5086,   5076,   5066,   5057,   5049,   5041,   5034, 
  5028,   5023,   5017,   5013,   5009,   5006,   5004,   5002,   5001,   5000, 

  5000,   5001,   5002,   5004,   5006,   5009,   5013,   5017,   5023,   5028, 
  5034,   5041,   5049,   5057,   5066,   5076,   5086,   5097,   5109,   5121, 
  5134,   5148,   5163,   5179,   5195,   5212,   5230,   5249,   5269,   5289, 
  5311,   5334,   5357,   5382,   5407,   5434,   5462,   5491,   5521,   5553, 
  5586,   5620,   5656,   5693,   5732,   5772,   5814,   5858,   5903,   5951, 
  6000,   6052,   6106,   6162,   6221,   6282,   6347,   6414,   6484,   6558, 
  6635,   6716,   6801,   6891,   6985,   7084,   7188,   7299,   7415,   7539, 
  7670,   7809,   7958,   8116,   8285,   8466,   8660,   8870,   9096,   9341, 
  9607,   9899,  10218,  10571,  10962,  11398,  11889,  12445,  13083,  13821, 
 14689,  15725,  16990,  18576,  20635,  23439,  27549,  34322,  48470, 183523
};
unsigned int delayTime_90_slow[TURN_90] = {
229404,  60587,  42902,  34437,  29299,  25793,  23220,  21238,  19657,  18361, 
 17276,  16353,  15557,  14861,  14248,  13702,  13213,  12773,  12374,  12009, 
 11676,  11370,  11087,  10825,  10582,  10356,  10145,   9947,   9762,   9588, 
  9424,   9269,   9123,   8985,   8855,   8731,   8613,   8501,   8395,   8294, 
  8197,   8105,   8017,   7933,   7853,   7776,   7703,   7632,   7565,   7500, 
  7438,   7379,   7322,   7267,   7215,   7164,   7116,   7070,   7025,   6982, 
  6941,   6902,   6864,   6828,   6793,   6759,   6727,   6696,   6667,   6639, 
  6612,   6586,   6561,   6537,   6515,   6493,   6473,   6454,   6435,   6418, 
  6401,   6386,   6371,   6357,   6345,   6333,   6321,   6311,   6302,   6293, 
  6285,   6278,   6272,   6266,   6262,   6258,   6255,   6252,   6251,   6250, 

  6250,   6251,   6252,   6255,   6258,   6262,   6266,   6272,   6278,   6285, 
  6293,   6302,   6311,   6321,   6333,   6345,   6357,   6371,   6386,   6401, 
  6418,   6435,   6454,   6473,   6493,   6515,   6537,   6561,   6586,   6612, 
  6639,   6667,   6696,   6727,   6759,   6793,   6828,   6864,   6902,   6941, 
  6982,   7025,   7070,   7116,   7164,   7215,   7267,   7322,   7379,   7438, 
  7500,   7565,   7632,   7703,   7776,   7853,   7933,   8017,   8105,   8197, 
  8294,   8395,   8501,   8613,   8731,   8855,   8985,   9123,   9269,   9424, 
  9588,   9762,   9947,  10145,  10356,  10582,  10825,  11087,  11370,  11676, 
 12009,  12374,  12773,  13213,  13702,  14248,  14861,  15557,  16353,  17276, 
 18361,  19657,  21238,  23220,  25793,  29299,  34437,  42902,  60587, 229404
};
unsigned int delayTime_1[TURN_1] = {
    1000
};

// 简单延时
void Delay(unsigned int times) {
    while (--times);
}

// 执行旋转动作
void Turn(SteppingMotor* motor, int step) {
    // 获取变量引用，方便操作
    IO* dir = &motor->dir;
    IO* plu = &motor->plu;
    unsigned int* delayTimeArr = 0;
    unsigned int i = 0;

    // 确定旋转方向
    if (step > 0) {
        dir->OFF(dir);
    } else {
        dir->ON(dir);
        step *= -1;
    }

    // 确定延时数组
    switch (step) {
    case TURN_180:
        delayTimeArr = ((g_robotState.speed == Fast) ? delayTime_180_fast : delayTime_180_slow);
        break;
    case TURN_90:
        delayTimeArr = ((g_robotState.speed == Fast) ? delayTime_90_fast : delayTime_90_slow);
        break;
    case TURN_1:
        delayTimeArr = delayTime_1;
        break;
    default:
        return;
    }

    // 执行旋转动作
    for (i = 0; i < step; ++i) {
        plu->ON(plu);
        Delay(delayTimeArr[i]);
        plu->OFF(plu);
        Delay(delayTimeArr[i]);
    }
}

// 使能或失能
void Enable(SteppingMotor* motor, Bool enable) {
    IO* ena = &motor->ena;
    ena->Set(ena, enable);
    // 确保已经使能或失能
    ena->Read(ena) ?
        printf("[stepping motor ENABLE!]") :
        printf("[stepping motor DISABLE!]");
}

// New
SteppingMotor NewSteppingMotor(IO plu, IO ena, IO dir) {
    SteppingMotor motor;
    motor.plu = plu;
    motor.ena = ena;
    motor.dir = dir;
    motor.Turn = Turn;
    motor.Enable = Enable;
    return motor;
}
