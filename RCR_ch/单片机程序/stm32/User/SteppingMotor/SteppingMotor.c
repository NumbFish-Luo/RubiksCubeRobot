#include <stdio.h>
#include "Order/Order.h"
#include "SteppingMotor/SteppingMotor.h"
#include "Config/Config.h"

// 延时数组，分快速和慢速两种类型
unsigned int delayTime_180_fast[TURN_180] = {
399745, 104944,  74045,  59246,  50262,  44124,  39616,  36143,  33368,  31092, 
 29184,  27560,  26156,  24928,  23845,  22880,  22013,  21232,  20521,  19873, 
 19278,  18730,  18223,  17753,  17316,  16908,  16526,  16168,  15831,  15514, 
 15214,  14931,  14662,  14407,  14166,  13935,  13716,  13506,  13306,  13115, 
 12931,  12756,  12587,  12426,  12270,  12121,  11977,  11838,  11705,  11576, 
 11452,  11331,  11215,  11103,  10994,  10889,  10787,  10688,  10593,  10500, 
 10410,  10322,  10238,  10155,  10075,   9997,   9921,   9847,   9775,   9705, 
  9637,   9571,   9506,   9443,   9381,   9322,   9263,   9206,   9150,   9096, 
  9043,   8991,   8940,   8891,   8842,   8795,   8749,   8704,   8660,   8617, 
  8574,   8533,   8493,   8453,   8414,   8376,   8340,   8303,   8268,   8233, 
  8199,   8165,   8133,   8101,   8069,   8039,   8009,   7979,   7950,   7922, 
  7895,   7867,   7841,   7815,   7789,   7764,   7740,   7716,   7692,   7669, 
  7646,   7624,   7602,   7581,   7560,   7540,   7520,   7500,   7481,   7462, 
  7444,   7426,   7408,   7391,   7374,   7358,   7341,   7326,   7310,   7295, 
  7280,   7265,   7251,   7237,   7224,   7211,   7198,   7185,   7172,   7160, 
  7149,   7137,   7126,   7115,   7104,   7094,   7084,   7074,   7064,   7055, 
  7046,   7037,   7029,   7020,   7012,   7004,   6997,   6989,   6982,   6976, 
  6969,   6963,   6956,   6951,   6945,   6939,   6934,   6929,   6924,   6920, 
  6916,   6912,   6908,   6904,   6901,   6897,   6894,   6892,   6889,   6887, 
  6885,   6883,   6881,   6879,   6878,   6877,   6876,   6876,   6875,   6875, 

  6875,   6875,   6876,   6876,   6877,   6878,   6879,   6881,   6883,   6885, 
  6887,   6889,   6892,   6894,   6897,   6901,   6904,   6908,   6912,   6916, 
  6920,   6924,   6929,   6934,   6939,   6945,   6951,   6956,   6963,   6969, 
  6976,   6982,   6989,   6997,   7004,   7012,   7020,   7029,   7037,   7046, 
  7055,   7064,   7074,   7084,   7094,   7104,   7115,   7126,   7137,   7149, 
  7160,   7172,   7185,   7198,   7211,   7224,   7237,   7251,   7265,   7280, 
  7295,   7310,   7326,   7341,   7358,   7374,   7391,   7408,   7426,   7444, 
  7462,   7481,   7500,   7520,   7540,   7560,   7581,   7602,   7624,   7646, 
  7669,   7692,   7716,   7740,   7764,   7789,   7815,   7841,   7867,   7895, 
  7922,   7950,   7979,   8009,   8039,   8069,   8101,   8133,   8165,   8199, 
  8233,   8268,   8303,   8340,   8376,   8414,   8453,   8493,   8533,   8574, 
  8617,   8660,   8704,   8749,   8795,   8842,   8891,   8940,   8991,   9043, 
  9096,   9150,   9206,   9263,   9322,   9381,   9443,   9506,   9571,   9637, 
  9705,   9775,   9847,   9921,   9997,  10075,  10155,  10238,  10322,  10410, 
 10500,  10593,  10688,  10787,  10889,  10994,  11103,  11215,  11331,  11452, 
 11576,  11705,  11838,  11977,  12121,  12270,  12426,  12587,  12756,  12931, 
 13115,  13306,  13506,  13716,  13935,  14166,  14407,  14662,  14931,  15214, 
 15514,  15831,  16168,  16526,  16908,  17316,  17753,  18223,  18730,  19278, 
 19873,  20521,  21232,  22013,  22880,  23845,  24928,  26156,  27560,  29184, 
 31092,  33368,  36143,  39616,  44124,  50262,  59246,  74045, 104944, 399745
};
unsigned int delayTime_180_slow[TURN_180] = {
436086, 114484,  80777,  64632,  54831,  48135,  43218,  39428,  36402,  33918, 
 31837,  30065,  28534,  27194,  26012,  24960,  24015,  23162,  22387,  21679, 
 21031,  20433,  19880,  19367,  18891,  18445,  18028,  17638,  17270,  16924, 
 16597,  16288,  15995,  15717,  15453,  15202,  14962,  14734,  14516,  14307, 
 14107,  13916,  13732,  13555,  13386,  13223,  13066,  12914,  12769,  12628, 
 12493,  12361,  12235,  12112,  11994,  11879,  11768,  11660,  11556,  11454, 
 11356,  11261,  11168,  11078,  10990,  10906,  10823,  10742,  10664,  10587, 
 10513,  10441,  10370,  10301,  10234,  10169,  10105,  10043,   9982,   9923, 
  9865,   9808,   9753,   9699,   9646,   9595,   9544,   9495,   9447,   9400, 
  9354,   9309,   9265,   9222,   9179,   9138,   9098,   9058,   9019,   8981, 
  8944,   8908,   8872,   8837,   8803,   8770,   8737,   8705,   8673,   8642, 
  8612,   8583,   8554,   8525,   8497,   8470,   8443,   8417,   8391,   8366, 
  8341,   8318,   8294,   8271,   8248,   8226,   8204,   8182,   8161,   8141, 
  8121,   8101,   8082,   8063,   8045,   8027,   8009,   7992,   7975,   7958, 
  7942,   7926,   7911,   7895,   7881,   7866,   7852,   7838,   7825,   7811, 
  7798,   7786,   7774,   7762,   7750,   7739,   7728,   7717,   7707,   7696, 
  7686,   7677,   7668,   7658,   7650,   7641,   7633,   7625,   7617,   7610, 
  7602,   7596,   7589,   7582,   7576,   7570,   7565,   7559,   7554,   7549, 
  7544,   7540,   7536,   7532,   7528,   7524,   7521,   7518,   7515,   7513, 
  7510,   7508,   7507,   7505,   7504,   7502,   7501,   7501,   7500,   7500, 

  7500,   7500,   7501,   7501,   7502,   7504,   7505,   7507,   7508,   7510, 
  7513,   7515,   7518,   7521,   7524,   7528,   7532,   7536,   7540,   7544, 
  7549,   7554,   7559,   7565,   7570,   7576,   7582,   7589,   7596,   7602, 
  7610,   7617,   7625,   7633,   7641,   7650,   7658,   7668,   7677,   7686, 
  7696,   7707,   7717,   7728,   7739,   7750,   7762,   7774,   7786,   7798, 
  7811,   7825,   7838,   7852,   7866,   7881,   7895,   7911,   7926,   7942, 
  7958,   7975,   7992,   8009,   8027,   8045,   8063,   8082,   8101,   8121, 
  8141,   8161,   8182,   8204,   8226,   8248,   8271,   8294,   8318,   8341, 
  8366,   8391,   8417,   8443,   8470,   8497,   8525,   8554,   8583,   8612, 
  8642,   8673,   8705,   8737,   8770,   8803,   8837,   8872,   8908,   8944, 
  8981,   9019,   9058,   9098,   9138,   9179,   9222,   9265,   9309,   9354, 
  9400,   9447,   9495,   9544,   9595,   9646,   9699,   9753,   9808,   9865, 
  9923,   9982,  10043,  10105,  10169,  10234,  10301,  10370,  10441,  10513, 
 10587,  10664,  10742,  10823,  10906,  10990,  11078,  11168,  11261,  11356, 
 11454,  11556,  11660,  11768,  11879,  11994,  12112,  12235,  12361,  12493, 
 12628,  12769,  12914,  13066,  13223,  13386,  13555,  13732,  13916,  14107, 
 14307,  14516,  14734,  14962,  15202,  15453,  15717,  15995,  16288,  16597, 
 16924,  17270,  17638,  18028,  18445,  18891,  19367,  19880,  20433,  21031, 
 21679,  22387,  23162,  24015,  24960,  26012,  27194,  28534,  30065,  31837, 
 33918,  36402,  39428,  43218,  48135,  54831,  64632,  80777, 114484, 436086
};
unsigned int delayTime_90_fast[TURN_90] = {
229404,  60587,  42902,  34437,  29299,  25793,  23220,  21238,  19657,  18361, 
 17276,  16353,  15557,  14861,  14248,  13702,  13213,  12773,  12374,  12009, 
 11676,  11370,  11087,  10825,  10582,  10356,  10145,   9947,   9762,   9588, 
  9424,   9269,   9123,   8985,   8855,   8731,   8613,   8501,   8395,   8294, 
  8197,   8105,   8017,   7933,   7853,   7776,   7703,   7632,   7565,   7500, 
  7438,   7379,   7322,   7267,   7215,   7164,   7116,   7070,   7025,   6982, 
  6941,   6902,   6864,   6828,   6793,   6759,   6727,   6696,   6667,   6639, 
  6612,   6586,   6561,   6537,   6515,   6493,   6473,   6454,   6435,   6418, 
  6401,   6386,   6371,   6357,   6345,   6333,   6321,   6311,   6302,   6293, 
  6285,   6278,   6272,   6266,   6262,   6258,   6255,   6252,   6251,   6250, 

  6250,   6251,   6252,   6255,   6258,   6262,   6266,   6272,   6278,   6285, 
  6293,   6302,   6311,   6321,   6333,   6345,   6357,   6371,   6386,   6401, 
  6418,   6435,   6454,   6473,   6493,   6515,   6537,   6561,   6586,   6612, 
  6639,   6667,   6696,   6727,   6759,   6793,   6828,   6864,   6902,   6941, 
  6982,   7025,   7070,   7116,   7164,   7215,   7267,   7322,   7379,   7438, 
  7500,   7565,   7632,   7703,   7776,   7853,   7933,   8017,   8105,   8197, 
  8294,   8395,   8501,   8613,   8731,   8855,   8985,   9123,   9269,   9424, 
  9588,   9762,   9947,  10145,  10356,  10582,  10825,  11087,  11370,  11676, 
 12009,  12374,  12773,  13213,  13702,  14248,  14861,  15557,  16353,  17276, 
 18361,  19657,  21238,  23220,  25793,  29299,  34437,  42902,  60587, 229404
};
unsigned int delayTime_90_slow[TURN_90] = {
275285,  72704,  51483,  41324,  35159,  30952,  27864,  25486,  23588,  22033, 
 20731,  19624,  18668,  17833,  17097,  16443,  15856,  15328,  14848,  14411, 
 14011,  13644,  13304,  12990,  12698,  12427,  12174,  11936,  11714,  11505, 
 11309,  11123,  10948,  10782,  10625,  10477,  10336,  10202,  10074,   9952, 
  9837,   9726,   9621,   9520,   9423,   9331,   9243,   9159,   9078,   9000, 
  8926,   8855,   8786,   8721,   8658,   8597,   8539,   8484,   8430,   8379, 
  8330,   8282,   8237,   8193,   8151,   8111,   8072,   8036,   8000,   7966, 
  7934,   7903,   7873,   7845,   7818,   7792,   7768,   7744,   7722,   7701, 
  7682,   7663,   7645,   7629,   7613,   7599,   7586,   7573,   7562,   7551, 
  7542,   7534,   7526,   7520,   7514,   7509,   7506,   7503,   7501,   7500, 

  7500,   7501,   7503,   7506,   7509,   7514,   7520,   7526,   7534,   7542, 
  7551,   7562,   7573,   7586,   7599,   7613,   7629,   7645,   7663,   7682, 
  7701,   7722,   7744,   7768,   7792,   7818,   7845,   7873,   7903,   7934, 
  7966,   8000,   8036,   8072,   8111,   8151,   8193,   8237,   8282,   8330, 
  8379,   8430,   8484,   8539,   8597,   8658,   8721,   8786,   8855,   8926, 
  9000,   9078,   9159,   9243,   9331,   9423,   9520,   9621,   9726,   9837, 
  9952,  10074,  10202,  10336,  10477,  10625,  10782,  10948,  11123,  11309, 
 11505,  11714,  11936,  12174,  12427,  12698,  12990,  13304,  13644,  14011, 
 14411,  14848,  15328,  15856,  16443,  17097,  17833,  18668,  19624,  20731, 
 22033,  23588,  25486,  27864,  30952,  35159,  41324,  51483,  72704, 275285
};
unsigned int delayTime_1[TURN_1] = {
    1000
};

// 简单延时
void Delay(unsigned int times) {
    while (--times);
}

// 执行旋转动作
void Turn(SteppingMotor* motor, int step) {
    // 获取变量引用，方便操作
    IO* dir = &motor->dir;
    IO* plu = &motor->plu;
    unsigned int* delayTimeArr = 0;
    unsigned int i = 0;

    // 确定旋转方向
    if (step > 0) {
        dir->OFF(dir);
    } else {
        dir->ON(dir);
        step *= -1;
    }

    // 确定延时数组
    switch (step) {
    case TURN_180:
        delayTimeArr = ((g_robotState.speed == Fast) ? delayTime_180_fast : delayTime_180_slow);
        break;
    case TURN_90:
        delayTimeArr = ((g_robotState.speed == Fast) ? delayTime_90_fast : delayTime_90_slow);
        break;
    case TURN_1:
        delayTimeArr = delayTime_1;
        break;
    default:
        return;
    }

    // 执行旋转动作
    for (i = 0; i < step; ++i) {
        plu->ON(plu);
        Delay(delayTimeArr[i] * 10);
        plu->OFF(plu);
        Delay(delayTimeArr[i] * 10);
    }
}

// 使能或失能
void Enable(SteppingMotor* motor, Bool enable) {
    IO* ena = &motor->ena;
    ena->Set(ena, enable);
    // 确保已经使能或失能
    ena->Read(ena) ?
        printf("[stepping motor ENABLE!]") :
        printf("[stepping motor DISABLE!]");
}

// New
SteppingMotor NewSteppingMotor(IO plu, IO ena, IO dir) {
    SteppingMotor motor;
    motor.plu = plu;
    motor.ena = ena;
    motor.dir = dir;
    motor.Turn = Turn;
    motor.Enable = Enable;
    return motor;
}
